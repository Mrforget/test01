草稿：

/*
渠道模块曝光点击次数
left join(
    select cnt as channel_module_view_pv,landing_page_id
    from(
        select channel_event_type,landing_page_id,count(channel_event_type) as cnt
        from mart_lingshou.fact_flow_sdk_act_landing_page_pv
        group by channel_event_type,landing_page_id
    )a
    where a.channel_event_type = 'view'
)ldpv2 on ldpv1.landing_page_id = ldpv2.landing_page_id

left join(
    select cnt as channel_module_click_pv,landing_page_id
    from(
        select channel_event_type,landing_page_id,count(channel_event_type) as cnt
        from mart_lingshou.fact_flow_sdk_act_landing_page_pv
        group by channel_event_type,landing_page_id
    )b
    where b.channel_event_type = 'click'
)ldpv3 on ldpv1.landing_page_id = ldpv3.landing_page_id
*/


/*
落地页对应的所有的
left join(
    select cnt as landing_module_view_pv,landing_page_id
    from(
        select landing_event_type,count(landing_event_type) as cnt,landing_page_id
        from mart_lingshou.fact_flow_sdk_act_landing_page_mv
        group by landing_event_type,landing_page_id
    )c
    where c.landing_event_type = 'view'
)ldmv1 on ldmv1.landing_page_id = ldpv1.landing_page_id

left join(
    select cnt as landing_module_click_pv,landing_page_id
    from(
        select landing_event_type,count(landing_event_type) as cnt,landing_page_id
        from mart_lingshou.fact_flow_sdk_act_landing_page_mv
        group by landing_event_type,landing_page_id
    )d
    where d.landing_event_type = 'click'
)ldmv2 on ldmv2.landing_page_id = ldpv1.landing_page_id
*/


select
            dt,
            first_channel_id,
            first_channel_name,
            second_channel_id,
            second_channel_name,
            third_channel_id,
            third_channel_name,
            channel_page_id,
            channel_op_id,
            channel_event_type,
            landing_page_id,
            landing_op_id,
            landing_event_type,
            activity_id,
            union_id,
            user_id,
            uuid,
            dpid,
            poi_id,
            city_id,
            location_id,
            locate_city_id,
            geo_city_id,
            aor_id,
            aor_type,
            client_id,
            os,
            app_version,
            device_model,
            download_channel,
            launch_channel,
            push_id,
            utm_source,
            utm_term,
            utm_medium,
            utm_campaign,
            utm_content,
            sum(channel_module_view_pv) as channel_module_view_pv,
            sum(channel_module_click_pv) as channel_module_click_pv,
            sum(landing_page_view_pv) as landing_page_view_pv,
            sum(landing_page_stay_time) as landing_page_stay_time,
            sum(landing_page_stay_pv) as landing_page_stay_pv,
            sum(landing_page_bounce_pv) as landing_page_bounce_pv,
            sum(landing_page_exit_pv) as landing_page_exit_pv,
            sum(landing_page_twohop_pv) as landing_page_twohop_pv,
            sum(landing_page_return_pv) as landing_page_return_pv,
            sum(landing_page_noclick_pv) as landing_page_noclick_pv,
            sum(landing_coupon_view_pv) as landing_coupon_view_pv,
            sum(landing_coupon_click_pv) as landing_coupon_click_pv,
            sum(poipage_view_pv) as poipage_view_pv,
            sum(spupage_view_pv) as spupage_view_pv,
            sum(addcart_pv) as addcart_pv,
            sum(subpage_view_pv) as subpage_view_pv,
            sum(subord_pv) as subord_pv,
            sum(pushord_pv) as pushord_pv,
            sum(arrord_pv_gmv) as arrord_pv_gmv,
            sum(original_amt_gmv) as original_amt_gmv,
            sum(actual_amt_gmv) as actual_amt_gmv,
            sum(poi_charge_amt_gmv) as poi_charge_amt_gmv,
            sum(agent_charge_amt_gmv) as agent_charge_amt_gmv,
            sum(nmd_charge_amt_gmv) as nmd_charge_amt_gmv,
            sum(outer_channel_charge_amt_gmv) as outer_channel_charge_amt_gmv,
            sum(sg_charge_amt_gmv) as sg_charge_amt_gmv,
            sum(arrord_pv_gtv) as arrord_pv_gtv,
            sum(original_amt_gtv) as original_amt_gtv,
            sum(actual_amt_gtv) as actual_amt_gtv,
            sum(poi_charge_amt_gtv) as poi_charge_amt_gtv,
            sum(agent_charge_amt_gtv) as agent_charge_amt_gtv,
            sum(nmd_charge_amt_gtv) as nmd_charge_amt_gtv,
            sum(outer_channel_charge_amt_gtv) as outer_channel_charge_amt_gtv,
            sum(sg_charge_amt_gtv) as sg_charge_amt_gtv,
            sum(mt_new_ord_pv) as mt_new_ord_pv,
            sum(wm_new_ord_pv) as wm_new_ord_pv,
            sum(sg_new_ord_pv) as sg_new_ord_pv,
            sum(cat_new_ord_pv) as cat_new_ord_pv
from(
select
            dt,
            first_channel_id,
            first_channel_name,
            second_channel_id,
            second_channel_name,
            third_channel_id,
            third_channel_name,
            channel_page_id,
            channel_op_id,
            channel_event_type,
            landing_page_id,
            landing_op_id,
            landing_event_type,
            attribute[activity_id] as activity_id,
            union_id,
            user_id,
            uuid,
            dpid,
            poi_id,
            city_id,
            location_id,
            locate_city_id,
            geo_city_id,
            aor_id,
            aor_type,
            client_id,
            os,
            app_version,
            device_model,
            download_channel,
            launch_channel,
            push_id,
            utm_source,
            utm_term,
            utm_medium,
            utm_campaign,
            utm_content,
            count(if(channel_event_type = 'view',channel_event_type,null)) as channel_module_view_pv,
            count(if(channel_event_type = 'click',channel_event_type,null)) as channel_module_click_pv,
            count(landing_page_id) as landing_page_view_pv,
            sum(page_stay_time) as landing_page_stay_time,
            count(if(page_stay_time!=0 and page_stay_time!=null,page_stay_time,null)) as landing_page_stay_pv,
            count(if(is_bounce_pv = 1,is_bounce_pv,null)) as landing_page_bounce_pv,
            count(if(is_exit = 1,is_exit,null)) as landing_page_exit_pv,
            count(if(is_twohop = 1,is_twohop,null)) as landing_page_twohop_pv,
            count(if(is_return=1,is_return,null)) as landing_page_return_pv,
            count(if(is_noclick=1,is_noclick,null)) as landing_page_noclick_pv,

            0 as landing_coupon_view_pv,
            0 as landing_coupon_click_pv,
            0 as poipage_view_pv,
            0 as spupage_view_pv,
            0 as addcart_pv,
            0 as subpage_view_pv,
            0 as subord_pv,
            0 as pushord_pv,
            0 as arrord_pv_gmv,
            0.0 as original_amt_gmv,
            0.0 as actual_amt_gmv,
            0.0 as poi_charge_amt_gmv,
            0.0 as agent_charge_amt_gmv,
            0.0 as nmd_charge_amt_gmv,
            0.0 as outer_channel_charge_amt_gmv,
            0.0 as sg_charge_amt_gmv,
            0.0 as arrord_pv_gtv,
            0.0 as original_amt_gtv,
            0.0 as actual_amt_gtv,
            0.0 as poi_charge_amt_gtv,
            0.0 as agent_charge_amt_gtv,
            0.0 as nmd_charge_amt_gtv,
            0.0 as outer_channel_charge_amt_gtv,
            0.0 as sg_charge_amt_gtv,
            0 as mt_new_ord_pv,
            0 as wm_new_ord_pv,
            0 as sg_new_ord_pv,
            0 as cat_new_ord_pv
from        mart_lingshou.fact_flow_sdk_act_landing_page_pv
where dt = '$now.datekey'
group by    dt,first_channel_id,first_channel_name,second_channel_id,second_channel_name,third_channel_id,third_channel_name,
            channel_page_id,channel_op_id,channel_event_type,landing_page_id,landing_op_id,landing_event_type,landing_attribute[activity_id] as activity_id,
            union_id,user_id,uuid,dpid,poi_id,city_id,location_id,locate_city_id,geo_city_id,aor_id,aor_type,client_id,os,
            app_version,device_model,download_channel,launch_channel,push_id,utm_source,utm_term,utm_medium,utm_campaign,utm_content
union all
--优惠券组建指标
select
            dt,
            first_channel_id,
            first_channel_name,
            second_channel_id,
            second_channel_name,
            third_channel_id,
            third_channel_name,
            channel_page_id,
            channel_op_id,
            channel_event_type,
            landing_page_id,
            landing_op_id,
            landing_event_type,
            landing_attribute[activity_id] as activity_id,
            union_id,
            user_id,
            uuid,
            dpid,
            poi_id,
            city_id,
            location_id,
            locate_city_id,
            geo_city_id,
            aor_id,
            aor_type,
            client_id,
            os,
            app_version,
            device_model,
            download_channel,
            launch_channel,
            push_id,
            utm_source,
            utm_term,
            utm_medium,
            utm_campaign,
            utm_content,
            0 as channel_module_view_pv,
            0 as channel_module_click_pv,
            0 as landing_page_view_pv,
            0 as landing_page_stay_time,
            0 as landing_page_stay_pv,
            0 as landing_page_bounce_pv,
            0 as landing_page_exit_pv,
            0 as landing_page_twohop_pv,
            0 as landing_page_return_pv,
            0 as landing_page_noclick_pv,
            count(if(COALESCE(get_json_object(landing_attribute['componentInfo'],'$.name'),'')='@gdc/sg-ticket-wall' and landing_event_type = 'view'),1,0) as landing_coupon_view_pv,
            count(if(COALESCE(get_json_object(landing_attribute['componentInfo'],'$.name'),'')='@gdc/sg-ticket-wall' and landing_event_type = 'click'),1,0) as landing_coupon_click_pv,
            0 as poipage_view_pv,
            0 as spupage_view_pv,
            0 as addcart_pv,
            0 as subpage_view_pv,
            0 as subord_pv,
            0 as pushord_pv,
            0 as arrord_pv_gmv,
            0.0 as original_amt_gmv,
            0.0 as actual_amt_gmv,
            0.0 as poi_charge_amt_gmv,
            0.0 as agent_charge_amt_gmv,
            0.0 as nmd_charge_amt_gmv,
            0.0 as outer_channel_charge_amt_gmv,
            0.0 as sg_charge_amt_gmv,
            0.0 as arrord_pv_gtv,
            0.0 as original_amt_gtv,
            0.0 as actual_amt_gtv,
            0.0 as poi_charge_amt_gtv,
            0.0 as agent_charge_amt_gtv,
            0.0 as nmd_charge_amt_gtv,
            0.0 as outer_channel_charge_amt_gtv,
            0.0 as sg_charge_amt_gtv,
            0 as mt_new_ord_pv,
            0 as wm_new_ord_pv,
            0 as sg_new_ord_pv,
            0 as cat_new_ord_pv
from        mart_lingshou.fact_flow_sdk_act_landing_page_mv
where dt = '$now.datekey'
group by    dt,first_channel_id,first_channel_name,second_channel_id,second_channel_name,third_channel_id,third_channel_name,
            channel_page_id,channel_op_id,channel_event_type,landing_page_id,landing_op_id,landing_event_type,landing_attribute[activity_id] as activity_id,
            union_id,user_id,uuid,dpid,poi_id,city_id,location_id,locate_city_id,geo_city_id,aor_id,aor_type,client_id,os,
            app_version,device_model,download_channel,launch_channel,push_id,utm_source,utm_term,utm_medium,utm_campaign,utm_content
union all
--页面曝光指标
select
            pv.dt,
            pv.first_channel_id,
            pv.first_channel_name,
            pv.second_channel_id,
            pv.second_channel_name,
            pv.third_channel_id,
            pv.third_channel_name,
            pv.channel_page_id,
            pv.channel_op_id,
            pv.channel_event_type,
            pv.landing_page_id,
            pv.landing_op_id,
            pv.landing_event_type,
            pv.activity_id,
            pv.union_id,
            pv.user_id,
            pv.uuid,
            pv.dpid,
            pv.poi_id,
            pv.city_id,
            pv.location_id,
            pv.locate_city_id,
            pv.geo_city_id,
            pv.aor_id,
            pv.aor_type,
            pv.client_id,
            pv.os,
            pv.app_version,
            pv.device_model,
            pv.download_channel,
            pv.launch_channel,
            pv.push_id,
            pv.utm_source,
            pv.utm_term,
            pv.utm_medium,
            pv.utm_campaign,
            pv.utm_content,
            0 as channel_module_view_pv,
            0 as channel_module_click_pv,
            0 as landing_page_view_pv,
            0 as landing_page_stay_time,
            0 as landing_page_stay_pv,
            0 as landing_page_bounce_pv,
            0 as landing_page_exit_pv,
            0 as landing_page_twohop_pv,
            0 as landing_page_return_pv,
            0 as landing_page_noclick_pv,
            0 as landing_coupon_view_pv,
            0 as landing_coupon_click_pv,
            count(if(pg.st_page_id='30002',ldpv1.union_id,null)) as poipage_view_pv,
            count(if(pg.st_page_id='30008',ldpv1.union_id,null)) as spupage_view_pv,
            0 as addcart_pv,
            count(if(pg.st_page_id='30004',ldpv1.union_id,null)) as subpage_view_pv,
            0 as subord_pv,
            0 as pushord_pv,
            0 as arrord_pv_gmv,
            0.0 as original_amt_gmv,
            0.0 as actual_amt_gmv,
            0.0 as poi_charge_amt_gmv,
            0.0 as agent_charge_amt_gmv,
            0.0 as nmd_charge_amt_gmv,
            0.0 as outer_channel_charge_amt_gmv,
            0.0 as sg_charge_amt_gmv,
            0.0 as arrord_pv_gtv,
            0.0 as original_amt_gtv,
            0.0 as actual_amt_gtv,
            0.0 as poi_charge_amt_gtv,
            0.0 as agent_charge_amt_gtv,
            0.0 as nmd_charge_amt_gtv,
            0.0 as outer_channel_charge_amt_gtv,
            0.0 as sg_charge_amt_gtv,
            0 as mt_new_ord_pv,
            0 as wm_new_ord_pv,
            0 as sg_new_ord_pv,
            0 as cat_new_ord_pv
from(
    select
            dt,
            first_channel_id,
            first_channel_name,
            second_channel_id,
            second_channel_name,
            third_channel_id,
            third_channel_name,
            channel_page_id,
            channel_op_id,
            channel_event_type,
            landing_page_id,
            landing_op_id,
            landing_event_type,
            landing_attribute[activity_id] as activity_id,
            union_id,
            user_id,
            uuid,
            dpid,
            poi_id,
            city_id,
            location_id,
            locate_city_id,
            geo_city_id,
            aor_id,
            aor_type,
            client_id,
            os,
            app_version,
            device_model,
            download_channel,
            launch_channel,
            push_id,
            utm_source,
            utm_term,
            utm_medium,
            utm_campaign,
            utm_content
    from    mart_lingshou.fact_flow_sdk_act_pv
    where dt = '$now.datekey'
)pv inner join(
select page_id,
       st_page_id,
from   mart_lingshou.dim_flow_sdk_page
where  st_page_id in ('30002','30004','30008')
)pg on pv.page_id = pg.page_id
group by    dt,first_channel_id,first_channel_name,second_channel_id,second_channel_name,third_channel_id,third_channel_name,
            channel_page_id,channel_op_id,channel_event_type,landing_page_id,landing_op_id,landing_event_type,landing_attribute[activity_id] as activity_id,
            union_id,user_id,uuid,dpid,poi_id,city_id,location_id,locate_city_id,geo_city_id,aor_id,aor_type,client_id,os,
            app_version,device_model,download_channel,launch_channel,push_id,utm_source,utm_term,utm_medium,utm_campaign,utm_content
union all
--加购指标
select
            dt,
            first_channel_id,
            first_channel_name,
            second_channel_id,
            second_channel_name,
            third_channel_id,
            third_channel_name,
            channel_page_id,
            channel_op_id,
            channel_event_type,
            landing_page_id,
            landing_op_id,
            landing_event_type,
            landing_attribute[activity_id] as activity_id,
            union_id,
            user_id,
            uuid,
            dpid,
            poi_id,
            city_id,
            location_id,
            locate_city_id,
            geo_city_id,
            aor_id,
            aor_type,
            client_id,
            os,
            app_version,
            device_model,
            download_channel,
            launch_channel,
            push_id,
            utm_source,
            utm_term,
            utm_medium,
            utm_campaign,
            utm_content,
            0 as channel_module_view_pv,
            0 as channel_module_click_pv,
            0 as landing_page_view_pv,
            0 as landing_page_stay_time,
            0 as landing_page_stay_pv,
            0 as landing_page_bounce_pv,
            0 as landing_page_exit_pv,
            0 as landing_page_twohop_pv,
            0 as landing_page_return_pv,
            0 as landing_page_noclick_pv,

            0 as landing_coupon_view_pv,
            0 as landing_coupon_click_pv,

            0 as poipage_view_pv,
            0 as spupage_view_pv,
            count(union_id) as addcart_pv,
            0 as subpage_view_pv,
            0 as subord_pv,
            0 as pushord_pv,
            0 as arrord_pv_gmv,
            0.0 as original_amt_gmv,
            0.0 as actual_amt_gmv,
            0.0 as poi_charge_amt_gmv,
            0.0 as agent_charge_amt_gmv,
            0.0 as nmd_charge_amt_gmv,
            0.0 as outer_channel_charge_amt_gmv,
            0.0 as sg_charge_amt_gmv,
            0.0 as arrord_pv_gtv,
            0.0 as original_amt_gtv,
            0.0 as actual_amt_gtv,
            0.0 as poi_charge_amt_gtv,
            0.0 as agent_charge_amt_gtv,
            0.0 as nmd_charge_amt_gtv,
            0.0 as outer_channel_charge_amt_gtv,
            0.0 as sg_charge_amt_gtv,
            0 as mt_new_ord_pv,
            0 as wm_new_ord_pv,
            0 as sg_new_ord_pv,
            0 as cat_new_ord_pv
from        mart_lingshou.fact_flow_sdk_act_cart
where dt = '$now.datekey'
group by    dt,first_channel_id,first_channel_name,second_channel_id,second_channel_name,third_channel_id,third_channel_name,
            channel_page_id,channel_op_id,channel_event_type,landing_page_id,landing_op_id,landing_event_type,landing_attribute[activity_id] as activity_id,
            union_id,user_id,uuid,dpid,poi_id,city_id,location_id,locate_city_id,geo_city_id,aor_id,aor_type,client_id,os,
            app_version,device_model,download_channel,launch_channel,push_id,utm_source,utm_term,utm_medium,utm_campaign,utm_content
union all
--订单指标
select
            dt,
            first_channel_id,
            first_channel_name,
            second_channel_id,
            second_channel_name,
            third_channel_id,
            third_channel_name,
            channel_page_id,
            channel_op_id,
            channel_event_type,
            landing_page_id,
            landing_op_id,
            landing_event_type,
            landing_attribute[activity_id] as activity_id,
            union_id,
            user_id,
            uuid,
            dpid,
            poi_id,
            city_id,
            location_id,
            locate_city_id,
            geo_city_id,
            aor_id,
            aor_type,
            client_id,
            os,
            app_version,
            device_model,
            download_channel,
            launch_channel,
            push_id,
            utm_source,
            utm_term,
            utm_medium,
            utm_campaign,
            utm_content,
            0 as channel_module_view_pv,
            0 as channel_module_click_pv,
            0 as landing_page_view_pv,
            0 as landing_page_stay_time,
            0 as landing_page_stay_pv,
            0 as landing_page_bounce_pv,
            0 as landing_page_exit_pv,
            0 as landing_page_twohop_pv,
            0 as landing_page_return_pv,
            0 as landing_page_noclick_pv,
            0 as landing_coupon_view_pv,
            0 as landing_coupon_click_pv,
            0 as poipage_view_pv,
            0 as spupage_view_pv,
            0 as addcart_pv,
            0 as subpage_view_pv,
            0 as subord_pv,
            0 as pushord_pv,
            0 as arrord_pv_gmv,
            0.0 as original_amt_gmv,
            0.0 as actual_amt_gmv,
            0.0 as poi_charge_amt_gmv,
            0.0 as agent_charge_amt_gmv,
            0.0 as nmd_charge_amt_gmv,
            0.0 as outer_channel_charge_amt_gmv,
            0.0 as sg_charge_amt_gmv,
            0.0 as arrord_pv_gtv,
            0.0 as original_amt_gtv,
            0.0 as actual_amt_gtv,
            0.0 as poi_charge_amt_gtv,
            0.0 as agent_charge_amt_gtv,
            0.0 as nmd_charge_amt_gtv,
            0.0 as outer_channel_charge_amt_gtv,
            0.0 as sg_charge_amt_gtv,
            0 as mt_new_ord_pv,
            0 as wm_new_ord_pv,
            0 as sg_new_ord_pv,
            0 as cat_new_ord_pv
            count(order_id) as subord_pv,
            count(if(is_push = 1,is_push,null)) as pushord_pv,
            count(if(is_arrange=1,is_arrange,null)) as arrord_pv_gmv,
            sum(if(is_arrange=1,original_price,0.0)) as original_amt_gmv,
            sum(if(is_arrange=1,actual_price,0.0)) as actual_amt_gmv,
            sum(if(is_arrange=1,poi_charge_amt,0.0)) as poi_charge_amt_gmv,
            sum(if(is_arrange=1,agent_charge_amt,0.0)) as agent_charge_amt_gmv,
            sum(if(is_arrange=1,nmd_charge_amt,0.0)) as nmd_charge_amt_gmv,
            sum(if(is_arrange=1,outer_channel_charge_amt,0.0)) as outer_channel_charge_amt_gmv,
            sum(if(is_arrange=1,sg_charge_amt,0.0)) as sg_charge_amt_gmv,
            count(if(is_gtv_arrange=1,is_gtv_arrange,null)) as arrord_pv_gtv,
            sum(if(is_gtv_arrange=1,original_price,0.0)) as original_amt_gtv,
            sum(if(is_gtv_arrange=1,actual_price,0.0)) as actual_amt_gtv,
            sum(if(is_gtv_arrange=1,poi_charge_amt,0.0)) as poi_charge_amt_gtv,
            sum(if(is_gtv_arrange=1,agent_charge_amt,0.0)) as agent_charge_amt_gtv,
            sum(if(is_gtv_arrange=1,nmd_charge_amt,0.0)) as nmd_charge_amt_gtv,
            sum(if(is_gtv_arrange=1,outer_channel_charge_amt,0.0)) as outer_channel_charge_amt_gtv,
            sum(if(is_gtv_arrange=1,sg_charge_amt,0.0)) as sg_charge_amt_gtv,
            count(if(is_first = 1, is_first, null)) as mt_new_ord_pv,
            count(if(is_first in (1, 2), is_first, null)) as wm_new_ord_pv,
            count(if(is_first in (1, 2, 3), is_first, null)) as sg_new_ord_pv,
            count(if(is_first in (1, 2, 3, 4), is_first, null)) as cat_new_ord_pv
from        mart_lingshou.fact_flow_sdk_act_order
where dt = '$now.datekey'
group by
            dt,first_channel_id,first_channel_name,second_channel_id,second_channel_name,third_channel_id,third_channel_name,
            channel_page_id,channel_op_id,channel_event_type,landing_page_id,landing_op_id,landing_event_type,landing_attribute[activity_id] as activity_id,
            union_id,user_id,uuid,dpid,poi_id,city_id,location_id,locate_city_id,geo_city_id,aor_id,aor_type,client_id,os,
            app_version,device_model,download_channel,launch_channel,push_id,utm_source,utm_term,utm_medium,utm_campaign,utm_content
)result
group by dt,first_channel_id,first_channel_name,second_channel_id,second_channel_name,third_channel_id,third_channel_name,
         channel_page_id,channel_op_id,channel_event_type,landing_page_id,landing_op_id,landing_event_type,activity_id,
         union_id,user_id,uuid,dpid,poi_id,city_id,location_id,locate_city_id,geo_city_id,aor_id,aor_type,client_id,os,
         app_version,device_model,download_channel,launch_channel,push_id,utm_source,utm_term,utm_medium,utm_campaign,utm_content